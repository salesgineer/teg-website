# TEG Next.js Architecture - Visual Diagrams

**Reference Document** - Architecture diagrams and flow charts

---

## 1. Multi-Language Routing Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Browser Request                          │
│                    (any URL path)                            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              Next.js Middleware                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ Check: Does URL have /locale/ ?                      │  │
│  │   ├─ YES (e.g., /lv/services) → Pass through        │  │
│  │   └─ NO (e.g., /services)     → Redirect to /lv/    │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        ▼            ▼            ▼
    /lv/page    /en/page    /ru/page
    (Latvian)   (English)   (Russian)
        │            │            │
        └────────────┼────────────┘
                     │
                     ▼
        ┌─────────────────────────┐
        │  [locale] Layout         │
        │  ├─ Set language        │
        │  ├─ Load translations   │
        │  └─ Render children     │
        └─────────────────────────┘
                     │
                     ▼
        Page Component (Hydrated)
```

---

## 2. Data Flow: Frontend to Backend

```
┌──────────────────────────────────────────────────────────────┐
│                    CLIENT SIDE                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ React Component (e.g., Appointment Form)               │  │
│  │  ├─ useForm Hook (React Hook Form)                    │  │
│  │  ├─ Validate with Zod Schema                          │  │
│  │  └─ Submit to API                                     │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │ POST /api/appointments                       │
│               ▼                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Network Request                                         │  │
│  │  ├─ Headers: content-type, auth token                 │  │
│  │  ├─ Body: validated form data                         │  │
│  │  └─ CORS: enabled for same origin                     │  │
│  └────────────┬───────────────────────────────────────────┘  │
└───────────────┼──────────────────────────────────────────────┘
                │
┌───────────────┼──────────────────────────────────────────────┐
│               ▼                                                │
│                    SERVER SIDE (Next.js API Route)           │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ API Route: /api/appointments/route.ts                 │  │
│  │  ├─ Check rate limiting (5 req/min per IP)            │  │
│  │  ├─ Parse request body                                │  │
│  │  ├─ Validate with Zod schema                          │  │
│  │  └─ Check authorization (user ID)                     │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │ Valid data                                    │
│               ▼                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Database Client (Supabase SDK)                        │  │
│  │  ├─ Create appointment record                         │  │
│  │  ├─ Return created record with ID                     │  │
│  │  └─ Handle errors (unique constraint, etc.)           │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │ Appointment created                           │
│               ▼                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Send Confirmation Email                               │  │
│  │  ├─ SendGrid API call                                │  │
│  │  ├─ Email template with appointment details           │  │
│  │  └─ Log email event (analytics)                       │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │ Response: 201 Created + appointment data      │
└───────────────┼──────────────────────────────────────────────┘
                │
┌───────────────┼──────────────────────────────────────────────┐
│               ▼                                                │
│                    CLIENT SIDE (Response)                    │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Handle API Response                                    │  │
│  │  ├─ 201: Show success message                         │  │
│  │  ├─ 400: Show validation errors                       │  │
│  │  ├─ 429: Show "try again later"                       │  │
│  │  └─ 500: Show "something went wrong"                  │  │
│  └────────────┬───────────────────────────────────────────┘  │
│               │                                               │
│               ▼                                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Update UI / Redirect                                  │  │
│  │  ├─ Clear form                                        │  │
│  │  ├─ Show confirmation page                            │  │
│  │  └─ Redirect to /appointments/[id]                    │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

---

## 3. Content Management: CMS to Page Rendering

```
┌──────────────────────────────────────────────────────────────┐
│                    Sanity Studio (CMS)                       │
│  Editor creates/updates content for locale:                  │
│  - Document Type: "service"                                  │
│  - Locale: "lv" | "en" | "ru"                               │
│  - Fields: title, description, features, pricing, etc.      │
└────────────────────┬─────────────────────────────────────────┘
                     │ Publish to dataset
                     ▼
┌──────────────────────────────────────────────────────────────┐
│               Sanity Backend (Cloud)                         │
│  Stores content in GROQ-queryable JSON format               │
│  - Different documents per locale                            │
│  - Revision history maintained                              │
│  - Real-time webhooks available                             │
└────────────────────┬─────────────────────────────────────────┘
                     │ Build time OR On-demand
                     ▼
┌──────────────────────────────────────────────────────────────┐
│           Next.js Build/Runtime                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Route: GET /[locale]/services/[service]              │   │
│  │  ├─ Extract: locale, service (slug)                  │   │
│  │  ├─ Generate Static Params: all locale + service     │   │
│  │  │  combinations                                      │   │
│  │  └─ Query Sanity for content                         │   │
│  └──────────┬───────────────────────────────────────────┘   │
│             │ GROQ Query                                    │
│             ▼                                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ getServiceDetails(slug, locale)                      │   │
│  │  Query: *[_type == "service" &&                      │   │
│  │         slug.current == $slug &&                     │   │
│  │         locale == $locale][0]                        │   │
│  └──────────┬───────────────────────────────────────────┘   │
└─────────────┼──────────────────────────────────────────────┘
              │ Parsed JSON response
              ▼
┌──────────────────────────────────────────────────────────────┐
│           React Component Rendering                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ <ServicePage params={locale, service}>               │   │
│  │  ├─ Server Component (async)                         │   │
│  │  ├─ Data: service object from Sanity                 │   │
│  │  ├─ Pass to <Hero>, <Features>, <Pricing>           │   │
│  │  └─ Render HTML + JSON-LD for SEO                   │   │
│  └──────────┬───────────────────────────────────────────┘   │
│             │ HTML + React hydration                        │
└─────────────┼──────────────────────────────────────────────┘
              ▼
    Browser displays page
    User interacts with components
```

---

## 4. Component Hierarchy

```
App Layout
├── Header
│   ├── Logo
│   ├── Navigation Menu
│   │   ├── Services (dropdown)
│   │   ├── About
│   │   ├── Contact
│   │   └── Blog
│   └── Language Switcher
│       ├── Latvian
│       ├── English
│       └── Russian
│
├── [locale] Layout
│   ├── Page-specific content
│   │   ├── Hero Section
│   │   ├── Features/Content
│   │   └── CTA Buttons
│   │
│   └── Modal/Overlays (if open)
│       ├── Appointment Form
│       │   ├── Service Selector
│       │   ├── Date Picker
│       │   ├── Contact Fields
│       │   └── Notes Textarea
│       ├── Contact Form
│       │   ├── Name, Email, Phone
│       │   ├── Subject
│       │   └── Message
│       └── Confirmation Modal
│
└── Footer
    ├── Company Info
    ├── Quick Links
    ├── Contact Details
    ├── Social Links
    └── Copyright & Legal
```

---

## 5. Database Schema (Supabase)

```
┌─────────────────────────────────────┐
│        appointments table            │
├─────────────────────────────────────┤
│ id (UUID, PK)                       │
│ user_id (UUID, FK → auth_users)     │
│ service_type (enum)                 │
│ │  ├─ pre-purchase-inspection       │
│ │  ├─ car-search-delivery           │
│ │  └─ roadside-service              │
│ vehicle_year (int)                  │
│ vehicle_make (varchar)              │
│ vehicle_model (varchar)             │
│ appointment_date (timestamp)        │
│ appointment_status (enum)           │
│ │  ├─ pending (awaiting confirmation)│
│ │  ├─ confirmed (user confirmed)    │
│ │  ├─ completed (appointment done)  │
│ │  └─ cancelled                     │
│ notes (text, nullable)              │
│ created_at (timestamp)              │
│ updated_at (timestamp)              │
│ confirmed_at (timestamp, nullable)  │
└─────────────────────────────────────┘
         ▲
         │ FK: user_id
         │
┌─────────────────────────────────────┐
│     auth.users (Auth table)         │
├─────────────────────────────────────┤
│ id (UUID, PK)                       │
│ email (varchar)                     │
│ phone (varchar, nullable)           │
│ created_at (timestamp)              │
│ updated_at (timestamp)              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│     contact_submissions table       │
├─────────────────────────────────────┤
│ id (UUID, PK)                       │
│ name (varchar)                      │
│ email (varchar)                     │
│ phone (varchar)                     │
│ subject (varchar)                   │
│ message (text)                      │
│ locale (enum: lv, en, ru)          │
│ status (enum: new, responded)       │
│ created_at (timestamp)              │
│ responded_at (timestamp, nullable)  │
└─────────────────────────────────────┘
```

---

## 6. Build & Deployment Pipeline

```
┌────────────────────┐
│  Developer pushes  │
│  code to main      │
└─────────┬──────────┘
          │
          ▼
┌────────────────────────────────────────────┐
│    GitHub Actions CI/CD Pipeline           │
└─────────┬──────────────────────────────────┘
          │
    ┌─────┴─────┬─────────┬──────────┐
    ▼           ▼         ▼          ▼
┌────────┐ ┌────────┐ ┌──────┐ ┌──────────┐
│ Lint  │ │ Build  │ │Tests │ │TypeScript│
│ Tests │ │& Check │ │Pass? │ │ Check   │
└───┬────┘ └───┬────┘ └──┬───┘ └────┬─────┘
    ├──────────┼─────────┤───────────┤
    └──────────┴─────────┴───────────┘
               │
          ┌────▼─────┐
          │ All OK?  │
          └────┬─────┘
               │ YES
               ▼
┌───────────────────────────────────────────┐
│    Build Next.js for Production           │
│  - Static export of pages                 │
│  - Optimize images                        │
│  - Minify CSS/JS                         │
│  - Generate sitemaps                      │
└──────────────┬────────────────────────────┘
               │
               ▼
┌───────────────────────────────────────────┐
│    Deploy to Vercel                       │
│  - Upload build artifacts                 │
│  - Configure environment variables        │
│  - Trigger edge functions                 │
│  - Set cache headers                      │
└──────────────┬────────────────────────────┘
               │
               ▼
┌───────────────────────────────────────────┐
│    Live on www.teg.lv                     │
│  - All 3 locales active                   │
│  - Content from Sanity CMS                │
│  - Appointments via Supabase              │
│  - Monitoring via Sentry + GA4            │
└───────────────────────────────────────────┘
```

---

## 7. Language Fallback Strategy

```
User requests: /en/services/pre-purchase-inspection

     ┌─────────────────────────┐
     │ Is page in English (en)?│
     └───────┬─────────────────┘
             │
        ┌────┴────┐
        ▼         ▼
      YES       NO
       │         │
       │         ▼
       │    ┌──────────────────────┐
       │    │ Fallback to Latvian? │
       │    │ (Default locale)     │
       │    └──────┬───────────────┘
       │           │
       │      ┌────┴────┐
       │      ▼         ▼
       │     YES       NO
       │      │         │
       └─────►└────┬────┘
              │
              ▼
    ┌─────────────────────┐
    │ Show available page │
    │ + Language switcher │
    │ to choose locale    │
    └─────────────────────┘
```

**Example Fallback Chain:**
```
Request: /en/about
  → Try: *[_type == "page" && slug == "about" && locale == "en"]
  → If empty: *[_type == "page" && slug == "about" && locale == "lv"]
  → Use Latvian version with language switcher
```

---

## 8. SEO & Structured Data

```
Page Response (HTML)
├─ <head>
│  ├─ Meta tags (og:title, og:description, etc.)
│  ├─ Canonical link
│  ├─ Alternate hreflang tags
│  │   ├─ <link rel="alternate" hreflang="lv" href="/lv/..." />
│  │   ├─ <link rel="alternate" hreflang="en" href="/en/..." />
│  │   └─ <link rel="alternate" hreflang="ru" href="/ru/..." />
│  ├─ Structured Data (JSON-LD)
│  │   └─ Schema.org
│  │      ├─ Organization
│  │      ├─ Service
│  │      ├─ LocalBusiness
│  │      └─ BreadcrumbList
│  └─ Analytics & tracking scripts
│
└─ <body>
   └─ Page content + React app
```

---

## 9. Performance Optimization Flow

```
Initial Page Load
│
├─ Critical Path
│  ├─ HTML (async)
│  ├─ CSS (critical, inline)
│  └─ React hydration (lazy)
│
├─ High Priority
│  ├─ Fonts (preload)
│  ├─ Hero images (LCP image)
│  └─ Navigation (interactive)
│
├─ Medium Priority
│  ├─ Other images (lazy load)
│  ├─ Secondary scripts
│  └─ Analytics (async)
│
└─ Low Priority
   ├─ Tracking pixels
   ├─ Third-party widgets
   └─ Non-critical resources

Target Results:
- LCP: < 2.5s (Largest Contentful Paint)
- FID: < 100ms (First Input Delay)
- CLS: < 0.1  (Cumulative Layout Shift)
```

---

## 10. Error Handling & Recovery

```
User Action
│
▼
Try {
  Validate input (Zod)
  │
  ├─ Validation error
  │  └─ Show form errors in red
  │
  Call API
  │
  ├─ 4xx Client Error (400, 401, 422, 429)
  │  └─ Show user-friendly message
  │
  ├─ 5xx Server Error (500, 503)
  │  ├─ Log to Sentry
  │  └─ Show "try again later"
  │
  └─ Success (200, 201)
     └─ Update UI / Redirect
}
Catch (unexpected error)
{
  Log to Sentry with context
  │
  ├─ Send error data
  │  ├─ Error message
  │  ├─ Stack trace
  │  ├─ User action
  │  ├─ Browser info
  │  └─ Network response
  │
  Show generic error message to user
  │
  └─ Provide support contact info
}
```

---

## Key Metrics Dashboard (Monitoring)

```
┌──────────────────────────────────────────────┐
│         Real-Time Monitoring                 │
├──────────────────────────────────────────────┤
│                                              │
│ Sentry (Error Tracking)                     │
│  ├─ Runtime errors: 0                       │
│  ├─ TypeError, ReferenceError: 0            │
│  ├─ API errors: < 1%                        │
│  └─ Latest errors: Last 24h                 │
│                                              │
│ Core Web Vitals (Lighthouse)                │
│  ├─ LCP: 2.1s ✅ (Target: < 2.5s)          │
│  ├─ FID: 45ms ✅ (Target: < 100ms)         │
│  ├─ CLS: 0.08 ✅ (Target: < 0.1)           │
│  └─ PageSpeed: 95/100 ✅                    │
│                                              │
│ Google Analytics 4                          │
│  ├─ Active users (now): 42                  │
│  ├─ Page views (today): 1,234               │
│  ├─ Bounce rate: 28%                        │
│  ├─ Avg. session duration: 3m 45s           │
│  └─ Conversion rate (bookings): 2.1%        │
│                                              │
│ Infrastructure (Vercel)                     │
│  ├─ Deployment status: ✅ Live             │
│  ├─ Build time: 2m 34s                      │
│  ├─ Response time (p95): 240ms              │
│  └─ Uptime: 99.97%                          │
│                                              │
└──────────────────────────────────────────────┘
```

---

**Document Version:** 1.0
**Created:** 2025-11-07 21:49 (Riga Time)
**Status:** Reference/Visual Aids
